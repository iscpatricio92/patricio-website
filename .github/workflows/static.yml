name: Build and Deploy to GitHub Pages

on:
  push:
    branches:
      - main

# Permissions required for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment per branch
concurrency:
  group: 'pages'
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Verify Node.js and npm versions
        run: |
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"

      - name: Install dependencies
        run: npm ci
        continue-on-error: false

      - name: Verify dependencies installation
        run: |
          if [ ! -d "node_modules" ]; then
            echo "Error: node_modules directory not found"
            exit 1
          fi
          echo "Dependencies installed successfully"

      - name: Security audit
        run: |
          echo "üîí Running security audit..."
          echo "Checking for high and critical vulnerabilities in production dependencies..."
          npm audit --audit-level=high --omit=dev || {
            echo ""
            echo "‚ö†Ô∏è  High or critical security vulnerabilities found in production dependencies!"
            echo ""
            echo "To fix automatically (if possible):"
            echo "  npm audit fix"
            echo ""
            echo "To review vulnerabilities:"
            echo "  npm audit"
            echo ""
            echo "Note: Some vulnerabilities may require manual updates or may not affect your use case."
            echo "Review the vulnerabilities above and update dependencies if necessary."
            exit 1
          }
          echo "‚úÖ Security audit passed (production dependencies)"
          echo ""
          echo "Checking dev dependencies (informational only)..."
          npm audit --audit-level=moderate --omit=optional || {
            echo "‚ÑπÔ∏è  Vulnerabilities found in dev dependencies (non-blocking)"
            echo "Consider running 'npm audit fix' to update dev dependencies when possible"
          }

      - name: Run ESLint
        run: |
          echo "üîç Running ESLint..."
          npm run lint
          echo "‚úÖ ESLint passed"

      - name: Check code formatting
        run: |
          echo "üé® Checking code formatting with Prettier..."
          npm run format:check
          echo "‚úÖ Code formatting is correct"

      - name: Type check with TypeScript
        run: |
          echo "üìò Running TypeScript type check..."
          npm run type-check
          echo "‚úÖ TypeScript type check passed"

      - name: Clean previous build (if exists)
        run: |
          if [ -d "dist" ]; then
            echo "Cleaning previous build directory..."
            rm -rf dist
          fi

      - name: Build project
        run: |
          echo "üî® Starting build..."
          npm run build
          echo "‚úÖ Build command completed"
        continue-on-error: false
        env:
          # Generar un hash √∫nico para cada build para forzar actualizaci√≥n del Service Worker
          BUILD_TIME: ${{ github.run_number }}-${{ github.sha }}
          # Sentry DSN (opcional - solo si est√° configurado como secret)
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
          # Sentry Auth Token para subir source maps (opcional)
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}

      - name: Display build summary
        run: |
          echo "üì¶ Build Summary:"
          echo "  - Build command: npm run build"
          echo "  - Build completed successfully"
          if [ -d "dist" ]; then
            echo "  - Output directory: dist/"
            echo "  - Total files in dist: $(find dist -type f | wc -l)"
            echo ""
            echo "Checking dist/index.html..."
            if [ -f "dist/index.html" ]; then
              echo "  - dist/index.html exists"
              echo "  - File size: $(wc -l < dist/index.html) lines"
              echo ""
              echo "Script tags in index.html:"
              grep -n "script.*src" dist/index.html || echo "  No script tags found"
            else
              echo "  ‚ùå dist/index.html NOT FOUND"
            fi
          else
            echo "  ‚ùå dist/ directory NOT FOUND"
          fi

      - name: Verify build output
        run: |
          echo "üîç Verifying build output..."

          if [ ! -d "dist" ]; then
            echo "‚ùå Error: dist directory not found after build"
            exit 1
          fi

          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå Error: dist/index.html not found"
            echo "Contents of dist/:"
            ls -la dist/ || echo "dist/ is empty or doesn't exist"
            exit 1
          fi

          echo "Checking index.html content..."
          echo "First 50 lines of dist/index.html:"
          head -50 dist/index.html
          echo ""

          # Check that index.html references .js files, not .tsx
          # Look for script src attributes that reference .tsx files
          # We check for the pattern: src="/src/main.tsx" or src='...tsx'
          if grep -q 'src="/src/main.tsx"' dist/index.html || grep -q "src='/src/main.tsx'" dist/index.html; then
            echo "‚ùå Error: index.html still references .tsx files in script src instead of compiled .js"
            echo "This indicates the build did not process index.html correctly"
            echo ""
            echo "Searching for problematic script src references:"
            grep -n 'src=.*\.tsx' dist/index.html || echo "No .tsx script src found"
            echo ""
            echo "All script tags with src in index.html:"
            grep -n 'script.*src' dist/index.html
            echo ""
            echo "First 100 lines of dist/index.html:"
            head -100 dist/index.html
            exit 1
          fi

          # Check that index.html has script tags with .js files
          if ! grep -q "script.*src.*\.js" dist/index.html; then
            echo "‚ö†Ô∏è  Warning: No .js script references found in index.html"
            echo "Script tags found:"
            grep -n "script" dist/index.html || echo "No script tags found"
          fi

          # Verify that JavaScript files exist
          JS_COUNT=$(find dist -name "*.js" -type f | wc -l)
          if [ "$JS_COUNT" -eq 0 ]; then
            echo "‚ùå Error: No JavaScript files found in dist/"
            echo "Contents of dist/:"
            ls -la dist/
            exit 1
          fi

          # List dist contents for debugging
          echo "‚úÖ Build output verification:"
          echo "  - dist/ directory exists"
          echo "  - dist/index.html exists"
          echo "  - index.html references compiled .js files (not .tsx)"
          echo "  - Found $JS_COUNT JavaScript file(s)"
          echo ""
          echo "Build output structure:"
          ls -la dist/ | head -20
          echo ""
          echo "JavaScript files in dist:"
          find dist -name "*.js" -type f | head -10
          echo ""
          echo "‚úÖ Build verification passed"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
